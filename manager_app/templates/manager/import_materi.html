{% extends 'base.html' %}
{% load static %}
{% block content %}

<div class="max-w-[1400px] mx-auto pt-4 pb-12 px-6 font-mono min-h-screen">
    <div class="mb-8 border-l-8 border-blue-600 pl-6 py-2 bg-white border-2 border-gray-900 shadow-[4px_4px_0px_#111827]">
        <h1 class="text-3xl font-black uppercase tracking-tighter text-gray-900">Import Data Otomatis</h1>
        <p class="text-[10px] font-bold text-blue-600 uppercase tracking-[0.3em]">Siapkan file .docx kamu dan biarkan sistem yang bekerja</p>
    </div>

    <div class="flex flex-col lg:flex-row gap-8">
        
        <div class="lg:w-2/3">
            <form action="" method="POST" enctype="multipart/form-data" id="import-form">
                {% csrf_token %}
                
                <div class="bg-white border-4 border-gray-900 p-8 shadow-[12px_12px_0px_#111827] space-y-8">
                    
                    <div class="space-y-2">
                        <label class="text-[10px] font-black uppercase tracking-widest text-gray-900 flex items-center gap-2">
                            <span class="w-2 h-2 bg-blue-600"></span> Pilih Course Tujuan
                        </label>
                        <select id="course_select" name="course_id" required 
                                class="w-full p-4 border-2 border-gray-900 bg-white font-bold text-xs outline-none transition-all focus:bg-blue-50 focus:shadow-[4px_4px_0px_#2563eb]">
                            <option value="" selected disabled>-- Pilih Mata Pelajaran --</option>
                            {% for course in courses %}
                                <option value="{{ course.id }}">{{ course.title }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 font-bold">Modul</label>
                            <select id="module_select" name="module_select" disabled 
                                    class="w-full p-4 border-2 border-gray-900 bg-gray-100 font-bold text-xs outline-none transition-all">
                                <option value="none">None (Buat Modul Baru)</option>
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 font-bold">Materi (Lesson)</label>
                            <select id="lesson_select" name="lesson_select" disabled 
                                    class="w-full p-4 border-2 border-gray-900 bg-gray-100 font-bold text-xs outline-none transition-all">
                                <option value="none">None (Buat Lesson Baru)</option>
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="text-[10px] font-black uppercase tracking-widest text-gray-400 font-bold">Kuis (Quiz)</label>
                            <select id="quiz_select" name="quiz_select" disabled 
                                    class="w-full p-4 border-2 border-gray-900 bg-gray-100 font-bold text-xs outline-none transition-all">
                                <option value="none">None (Buat Kuis Baru)</option>
                            </select>
                        </div>
                    </div>

                    <hr class="border-t-2 border-gray-900 border-dashed">

                    <div class="space-y-3">
                        <label class="text-[11px] font-black uppercase tracking-widest text-gray-900 italic text-blue-600 underline">Upload File Word (.docx)</label>
                        <div id="drop-zone" class="relative border-4 border-dashed border-gray-300 p-16 text-center bg-gray-50 transition-all hover:bg-blue-50 hover:border-blue-600 group cursor-pointer">
                            <input type="file" name="file_materi" id="file_input" accept=".docx" required 
                                   class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                            
                            <div class="space-y-4 pointer-events-none">
                                <i class="fa-solid fa-file-word text-5xl text-gray-300 group-hover:text-blue-600 transition-colors"></i>
                                <div id="file-info">
                                    <p class="text-sm font-black uppercase tracking-widest text-gray-900">Geser file ke sini atau klik</p>
                                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-tighter italic">Pastikan format file sudah benar</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-gray-900 text-white py-5 font-black uppercase tracking-[0.3em] text-xs border-2 border-gray-900 shadow-[6px_6px_0px_#2563eb] hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all">
                        Mulai Proses Import Sekarang
                    </button>
                </div>
            </form>
        </div>

        <div class="lg:w-1/3 space-y-6">
            <div class="bg-white border-4 border-gray-900 p-6 shadow-[8px_8px_0px_#eab308]">
                <h3 class="text-sm font-black uppercase tracking-widest text-gray-900 mb-6 flex items-center gap-2">
                    <span class="w-3 h-3 bg-yellow-400 border border-gray-900"></span> Panduan Cepat Import
                </h3>
                
                <div class="space-y-6">
                    <div class="relative pl-8">
                        <span class="absolute left-0 top-0 font-black text-2xl text-gray-200">01</span>
                        <h4 class="text-[11px] font-black uppercase text-gray-900 mb-1">Pilih Lokasi Materi</h4>
                        <p class="text-[10px] font-bold text-gray-500 leading-relaxed uppercase">Pilih Kursus mana yang mau kamu isi. Kalau kamu pilih <span class="text-black">"NONE"</span> di kotak bawahnya, sistem akan otomatis bikin Modul/Materi baru buat kamu.</p>
                    </div>

                    <div class="relative pl-8">
                        <span class="absolute left-0 top-0 font-black text-2xl text-gray-200">02</span>
                        <h4 class="text-[11px] font-black uppercase text-gray-900 mb-1">Siapkan File Word</h4>
                        <p class="text-[10px] font-bold text-gray-500 leading-relaxed uppercase">Isi file Word kamu harus rapi. Gunakan tanda penanda materi supaya sistem nggak bingung waktu baca file kamu.</p>
                    </div>

                    <div class="relative pl-8">
                        <span class="absolute left-0 top-0 font-black text-2xl text-gray-200">03</span>
                        <h4 class="text-[11px] font-black uppercase text-gray-900 mb-1">Upload & Tunggu</h4>
                        <p class="text-[10px] font-bold text-gray-500 leading-relaxed uppercase">Tarik file Word kamu ke kotak besar, lalu klik tombol hitam. Sistem bakal kerja otomatis buat masukin semua materinya.</p>
                    </div>
                </div>
            </div>

            <div class="bg-gray-900 p-6 shadow-[8px_8px_0px_#cbd5e1]">
                <h3 class="text-xs font-black uppercase tracking-widest text-white mb-4 italic">Butuh Contoh Format?</h3>
                <p class="text-[9px] text-gray-400 font-bold uppercase mb-6 leading-loose">
                    Biar nggak salah format, kamu bisa download contoh file Word-nya di bawah ini buat jadi patokan.
                </p>
                <a href="{% static 'documents/TEMPLATE.docx' %}" download="TEMPLATE.docx" class="flex items-center justify-between bg-white p-4 border-2 border-white hover:bg-yellow-400 transition-all group">
                    <span class="text-[10px] font-black uppercase text-gray-900">Download Template.docx</span>
                    <i class="fa-solid fa-download text-gray-900 group-hover:animate-bounce"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    const courseSelect = document.getElementById('course_select');
    const moduleSelect = document.getElementById('module_select');
    const lessonSelect = document.getElementById('lesson_select');
    const quizSelect = document.getElementById('quiz_select');
    const fileInput = document.getElementById('file_input');
    const fileInfo = document.getElementById('file-info');
    const dropZone = document.getElementById('drop-zone');
    const importForm = document.getElementById('import-form');

    const dataStruktur = {
        {% for course in courses %}
            "{{ course.id }}": [
                {% for module in course.modules.all %}
                {
                    "id": "{{ module.id }}", 
                    "title": "{{ module.title }}",
                    "lessons": [{% for l in module.lessons.all %}{% if not l.is_quiz %}{"id":"{{l.id}}","title":"{{l.title}}"},{% endif %}{% endfor %}],
                    "quizzes": [{% for l in module.lessons.all %}{% if l.is_quiz %}{"id":"{{l.id}}","title":"{{l.title}}"},{% endif %}{% endfor %}]
                },
                {% endfor %}
            ],
        {% endfor %}
    };

    courseSelect.addEventListener('change', function() {
        const modules = dataStruktur[this.value] || [];
        enableSelect(moduleSelect);
        moduleSelect.innerHTML = '<option value="none">BUAT MODUL BARU</option>';
        modules.forEach(m => moduleSelect.add(new Option(m.title, m.id)));
        resetSelect(lessonSelect);
        resetSelect(quizSelect);
    });

    moduleSelect.addEventListener('change', function() {
        if (this.value === 'none') {
            resetSelect(lessonSelect);
            resetSelect(quizSelect);
        } else {
            const moduleData = dataStruktur[courseSelect.value].find(m => m.id == this.value);
            enableSelect(lessonSelect);
            enableSelect(quizSelect);
            populate(lessonSelect, moduleData.lessons);
            populate(quizSelect, moduleData.quizzes);
        }
    });

    function resetSelect(el) {
        el.disabled = true; el.value = 'none';
        el.classList.replace('bg-white', 'bg-gray-100');
        el.innerHTML = '<option value="none">TIDAK ADA</option>';
    }

    function enableSelect(el) {
        el.disabled = false;
        el.classList.replace('bg-gray-100', 'bg-white');
    }

    function populate(el, items) {
        el.innerHTML = '<option value="none">BUAT BARU</option>';
        items.forEach(item => el.add(new Option(item.title, item.id)));
    }

    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            fileInfo.innerHTML = `<p class="text-sm font-black text-blue-600 uppercase underline italic">${this.files[0].name}</p>`;
            dropZone.classList.add('border-blue-600', 'bg-blue-50');
        }
    });

    // PERBAIKAN: Aktifkan input sebelum submit agar file & data terkirim
    importForm.addEventListener('submit', function() {
        moduleSelect.disabled = false;
        lessonSelect.disabled = false;
        quizSelect.disabled = false;
    });
</script>
{% endblock %}